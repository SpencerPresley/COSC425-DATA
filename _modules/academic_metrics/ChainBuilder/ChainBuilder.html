<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>academic_metrics.ChainBuilder.ChainBuilder &#8212; Academic Metrics 0.1.0-beta documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic_mod.css?v=9b2032db" />
    <script src="../../../_static/documentation_options.js?v=c903bf51"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <script src="../../../_static/js/petite-vue.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body data-dark_mode_code_blocks="true">

<div id="top_nav">
    

    <nav>
        
            
        

        <p id="toggle_sidebar">
            <a href="#" title="Toggle sidebar">|||</a>
        </p>
        <h1><a href="../../../index.html" title="Go to homepage">Academic Metrics 0.1.0-beta documentation</a></h1>

        <a id="mode_toggle" href="#" @click.prevent="handleClick" :title="mode">
    <template v-if="mode == 'light'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_light"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><circle cx="39.311" cy="39.524" r="15.734" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.212,4.901c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901l-0,9.614c-0,2.705 2.196,4.901 4.9,4.901c2.705,0 4.901,-2.196 4.901,-4.901l0,-9.614Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M67.48,18.073c1.913,-1.912 1.913,-5.018 0,-6.931c-1.912,-1.912 -5.018,-1.912 -6.931,0l-6.798,6.799c-1.912,1.912 -1.912,5.018 0,6.931c1.913,1.912 5.018,1.912 6.931,-0l6.798,-6.799Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.728,61.108c1.912,-1.913 1.912,-5.018 -0,-6.931c-1.913,-1.913 -5.019,-1.913 -6.931,-0l-6.799,6.798c-1.912,1.913 -1.912,5.019 0,6.931c1.913,1.913 5.019,1.913 6.931,0l6.799,-6.798Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.682,54.177c-1.913,-1.913 -5.018,-1.913 -6.931,-0c-1.912,1.913 -1.912,5.018 0,6.931l6.798,6.798c1.913,1.913 5.019,1.913 6.931,0c1.913,-1.912 1.913,-5.018 0,-6.931l-6.798,-6.798Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M4.901,34.623c-2.705,0 -4.901,2.196 -4.901,4.901c0,2.705 2.196,4.901 4.901,4.901l9.614,0c2.705,0 4.901,-2.196 4.901,-4.901c0,-2.705 -2.196,-4.901 -4.901,-4.901l-9.614,0Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.212,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901l-0,9.614c-0,2.705 2.196,4.901 4.9,4.901c2.705,-0 4.901,-2.196 4.901,-4.901l0,-9.614Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M18.929,11.142c-1.912,-1.912 -5.018,-1.912 -6.931,0c-1.912,1.913 -1.912,5.019 0,6.931l6.799,6.799c1.912,1.912 5.018,1.912 6.931,-0c1.912,-1.913 1.912,-5.019 -0,-6.931l-6.799,-6.799Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.108,34.623c-2.705,0 -4.901,2.196 -4.901,4.901c-0,2.705 2.196,4.901 4.901,4.901l9.614,0c2.705,0 4.901,-2.196 4.901,-4.901c-0,-2.705 -2.196,-4.901 -4.901,-4.901l-9.614,0Z" style="fill:#fff;"/></g></g></g></svg>
    </template>

    <template v-if="mode == 'dark'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_dark"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><circle cx="39.311" cy="39.524" r="15.734" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.212,14.515c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,0 -4.901,2.196 -4.901,4.901c0,2.705 2.197,4.901 4.901,4.901c2.705,0 4.901,-2.196 4.901,-4.901Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M60.662,24.892c1.902,-1.902 1.902,-4.99 0,-6.892l-0.04,-0.039c-1.901,-1.902 -4.989,-1.902 -6.891,-0c-1.901,1.901 -1.901,4.989 0,6.891l0.04,0.04c1.902,1.901 4.989,1.901 6.891,-0Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.732,61.103c1.91,-1.91 1.91,-5.011 0,-6.921l-0.009,-0.01c-1.91,-1.91 -5.012,-1.91 -6.921,-0c-1.91,1.91 -1.91,5.011 -0,6.921l0.01,0.01c1.909,1.91 5.011,1.91 6.92,-0Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.672,54.167c-1.907,-1.907 -5.004,-1.907 -6.911,0l-0.02,0.02c-1.907,1.907 -1.907,5.004 0,6.911c1.907,1.907 5.004,1.907 6.911,-0l0.02,-0.02c1.907,-1.907 1.907,-5.004 0,-6.911Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M14.52,34.623c-2.702,0 -4.896,2.194 -4.896,4.896l0,0.01c0,2.702 2.194,4.896 4.896,4.896c2.702,0 4.896,-2.194 4.896,-4.896l-0,-0.01c-0,-2.702 -2.194,-4.896 -4.896,-4.896Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.212,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.901,2.196 -4.901,4.901c0,2.704 2.197,4.9 4.901,4.9c2.705,0 4.901,-2.196 4.901,-4.9Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M25.73,17.943c-1.911,-1.911 -5.015,-1.911 -6.926,0l-0.005,0.005c-1.911,1.911 -1.911,5.015 0,6.926c1.911,1.911 5.015,1.911 6.926,0l0.005,-0.005c1.911,-1.911 1.911,-5.014 -0,-6.926Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.098,34.623c-2.699,0 -4.891,2.192 -4.891,4.892l-0,0.019c-0,2.699 2.192,4.891 4.891,4.891c2.7,0 4.892,-2.192 4.892,-4.891l0,-0.019c0,-2.7 -2.192,-4.892 -4.892,-4.892Z" style="fill:#fff;"/></g></g></g></svg>
    </template>

    <template v-if="mode == 'darkest'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_darkest"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><path d="M39.315,23.791c8.684,-0 15.734,7.05 15.734,15.733c0,8.684 -7.05,15.734 -15.734,15.734c-8.683,0 -15.733,-7.05 -15.733,-15.734c-0,-8.683 7.05,-15.733 15.733,-15.733Zm0,4.737c6.069,0 10.997,4.927 10.997,10.996c-0,6.069 -4.928,10.996 -10.997,10.996c-6.068,0 -10.996,-4.927 -10.996,-10.996c0,-6.069 4.928,-10.996 10.996,-10.996Z" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.216,14.515c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,0 -4.9,2.196 -4.9,4.901c-0,2.705 2.196,4.901 4.9,4.901c2.705,0 4.901,-2.196 4.901,-4.901Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M60.666,24.892c1.902,-1.902 1.902,-4.99 0,-6.892l-0.04,-0.039c-1.901,-1.902 -4.989,-1.902 -6.891,-0c-1.901,1.901 -1.901,4.989 0,6.891l0.04,0.04c1.902,1.901 4.99,1.901 6.891,-0Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.737,61.103c1.909,-1.91 1.909,-5.011 -0,-6.921l-0.01,-0.01c-1.91,-1.91 -5.011,-1.91 -6.921,-0c-1.91,1.91 -1.91,5.011 -0,6.921l0.01,0.01c1.91,1.91 5.011,1.91 6.921,-0Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.676,54.167c-1.907,-1.907 -5.004,-1.907 -6.911,0l-0.02,0.02c-1.907,1.907 -1.907,5.004 0,6.911c1.907,1.907 5.004,1.907 6.911,-0l0.02,-0.02c1.907,-1.907 1.907,-5.004 0,-6.911Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M14.524,34.623c-2.702,0 -4.896,2.194 -4.896,4.896l0,0.01c0,2.702 2.194,4.896 4.896,4.896c2.702,0 4.896,-2.194 4.896,-4.896l0,-0.01c0,-2.702 -2.194,-4.896 -4.896,-4.896Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.216,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901c-0,2.704 2.196,4.9 4.9,4.9c2.705,0 4.901,-2.196 4.901,-4.9Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M25.734,17.943c-1.911,-1.911 -5.015,-1.911 -6.926,0l-0.005,0.005c-1.911,1.911 -1.911,5.015 0,6.926c1.911,1.911 5.015,1.911 6.926,0l0.005,-0.005c1.911,-1.911 1.911,-5.014 0,-6.926Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.103,34.623c-2.7,0 -4.892,2.192 -4.892,4.892l-0,0.019c-0,2.699 2.192,4.891 4.892,4.891c2.699,0 4.891,-2.192 4.891,-4.891l0,-0.019c0,-2.7 -2.192,-4.892 -4.891,-4.892Z" style="fill:#fff;"/></g></g></g></svg>
    </template>
</a>

<script>
(function() {
    const LOCAL_STORAGE_KEY = 'piccoloThemeMode'

    var initialMode = localStorage.getItem(LOCAL_STORAGE_KEY)

    if (initialMode) {
        // Make sure the value in local storage is valid
        if (['light', 'dark', 'darkest'].indexOf(initialMode) == -1) {
            initialMode = 'light'
            localStorage.setItem(LOCAL_STORAGE_KEY, initialMode)
        }
    } else {
        // Check if the client prefers dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            initialMode = 'dark'
        } else {
            initialMode = 'light'
        }
        localStorage.setItem(LOCAL_STORAGE_KEY, initialMode)
    }

    document.documentElement.dataset.mode = initialMode

    PetiteVue.createApp({
        'mode': initialMode,
        handleClick() {
            let currentMode = this.mode

            if (currentMode == 'light') {
                this.mode = 'dark'
            } else if (currentMode == 'dark') {
                this.mode = 'darkest'
            } else if (currentMode == 'darkest') {
                this.mode = 'light'
            }

            document.documentElement.dataset.mode = this.mode
            localStorage.setItem(LOCAL_STORAGE_KEY, this.mode)

            console.log(this.mode)
        }
    }).mount('#mode_toggle')
})()
</script>
            <p class="mobile_search_link">
                <a href="../../../search.html" title="Search">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 65 64" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2">
                        <path d="M14.873 40.009c-2.315-3.943-3.642-8.532-3.642-13.429C11.231 11.91 23.141 0 37.811 0s26.58 11.91 26.58 26.58-11.91 26.58-26.58 26.58a26.44 26.44 0 0 1-14.277-4.161L9.739 62.794a3.12 3.12 0 0 1-4.413 0L.913 58.382c-1.217-1.218-1.217-3.196 0-4.413l13.96-13.96zM37.811 8.054c10.225 0 18.526 8.301 18.526 18.526s-8.301 18.526-18.526 18.526-18.526-8.301-18.526-18.526S27.586 8.054 37.811 8.054z" fill="#fff" />
                    </svg>
                </a>
            </p>
        

        <div class="searchbox_wrapper">
            
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
    </nav>
</div>

    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../abstract_classifier.html">Abstract Classifier Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../category_processor.html">Category Processor Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faculty_set_postprocessor.html">Faculty Set Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config.html">Global Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../chain_builder.html">Chain Builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai_prompts.html">ai_prompts package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_collection.html">data_collection package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataclass_models.html">dataclass_models package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../DB.html">DB package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../enums.html">enums package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../factories.html">factories package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../orchestrators.html">orchestrators package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../runners.html">runners package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../strategies.html">strategies package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html">utils package</a></li>
</ul>

        </div>
      </div>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for academic_metrics.ChainBuilder.ChainBuilder</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
    <span class="n">TypeAlias</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">langchain.prompts</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ChatPromptTemplate</span><span class="p">,</span>
    <span class="n">HumanMessagePromptTemplate</span><span class="p">,</span>
    <span class="n">PromptTemplate</span><span class="p">,</span>
    <span class="n">SystemMessagePromptTemplate</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">langchain.schema.runnable</span> <span class="kn">import</span> <span class="n">Runnable</span><span class="p">,</span> <span class="n">RunnablePassthrough</span>
<span class="kn">from</span> <span class="nn">langchain_anthropic</span> <span class="kn">import</span> <span class="n">ChatAnthropic</span>
<span class="kn">from</span> <span class="nn">langchain_core.output_parsers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">JsonOutputParser</span><span class="p">,</span>
    <span class="n">PydanticOutputParser</span><span class="p">,</span>
    <span class="n">StrOutputParser</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">langchain_google_genai</span> <span class="kn">import</span> <span class="n">ChatGoogleGenerativeAI</span>
<span class="kn">from</span> <span class="nn">langchain_openai</span> <span class="kn">import</span> <span class="n">ChatOpenAI</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>

<span class="kn">import</span> <span class="nn">tiktoken</span>

<span class="c1"># ! THIS NEEDS TO BE REMOVED WHEN THIS IS MADE A STANDALONE PACKAGE</span>
<span class="kn">from</span> <span class="nn">academic_metrics.configs</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">configure_logging</span><span class="p">,</span>
    <span class="n">LOG_TO_CONSOLE</span><span class="p">,</span>
    <span class="n">DEBUG</span><span class="p">,</span>
    <span class="n">INFO</span><span class="p">,</span>
    <span class="n">WARNING</span><span class="p">,</span>
    <span class="n">ERROR</span><span class="p">,</span>
    <span class="n">CRITICAL</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">FirstCallRequired</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;FirsCallRequired&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span>
<span class="sd">&quot;&quot;&quot;TypeVar representing a dictionary that is required on first call but optional after.</span>

<span class="sd">Type Structure:</span>
<span class="sd">    TypeVar bound to Dict[str, Any]</span>

<span class="sd">Usage:</span>
<span class="sd">    Used to enforce that a dictionary parameter must be provided on first call</span>
<span class="sd">    but can be optional on subsequent calls.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">ParserUnion</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">PydanticOutputParser</span><span class="p">,</span> <span class="n">JsonOutputParser</span><span class="p">,</span> <span class="n">StrOutputParser</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;Union type representing valid parser types.</span>

<span class="sd">Type Structure:</span>
<span class="sd">    Union[PydanticOutputParser, JsonOutputParser, StrOutputParser]</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">ParserType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;ParserType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">ParserUnion</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;TypeVar representing the main parser type.</span>

<span class="sd">Type Structure:</span>
<span class="sd">    TypeVar bound to Union[PydanticOutputParser, JsonOutputParser, StrOutputParser]</span>

<span class="sd">Usage:</span>
<span class="sd">    Used to enforce type consistency for the primary parser in chain operations.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">FallbackParserType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;FallbackParserType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">ParserUnion</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;TypeVar representing the fallback parser type.</span>

<span class="sd">Type Structure:</span>
<span class="sd">    TypeVar bound to Union[PydanticOutputParser, JsonOutputParser, StrOutputParser]</span>

<span class="sd">Usage:</span>
<span class="sd">    Used to enforce type consistency for the fallback parser in chain operations.</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="ChainBuilder">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainBuilder">[docs]</a>
<span class="k">class</span> <span class="nc">ChainBuilder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A builder class for constructing and configuring LangChain chains with logging and parsing capabilities.</span>

<span class="sd">    This class provides functionality to construct LangChain chains with customizable prompts,</span>
<span class="sd">    language models, and output parsers. It includes support for logging, fallback chains,</span>
<span class="sd">    and various parser types.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        log_file_path (Path): Path to the log file.</span>
<span class="sd">        logger (logging.Logger): Logger instance for the chain builder.</span>
<span class="sd">        chat_prompt (ChatPromptTemplate): Template for chat prompts.</span>
<span class="sd">        parser (Optional[ParserType]): Primary output parser.</span>
<span class="sd">        fallback_parser (Optional[FallbackParserType]): Fallback output parser.</span>
<span class="sd">        llm (Union[ChatOpenAI, ChatAnthropic, ChatGoogleGenerativeAI]): Language model instance.</span>
<span class="sd">        chain (Runnable): Primary chain instance.</span>
<span class="sd">        fallback_chain (Runnable): Fallback chain instance.</span>

<span class="sd">    Methods:</span>
<span class="sd">        get_chain(): Returns the primary chain instance.</span>
<span class="sd">        get_fallback_chain(): Returns the fallback chain instance.</span>
<span class="sd">        __str__(): Returns a string representation of the ChainBuilder.</span>
<span class="sd">        __repr__(): Returns a string representation of the ChainBuilder.</span>
<span class="sd">        _run_pydantic_parser_logging(): Logs Pydantic parser configuration.</span>
<span class="sd">        _build_chain(): Constructs the primary chain.</span>
<span class="sd">        _build_fallback_chain(): Constructs the fallback chain.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ChainBuilder.__init__">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainBuilder.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">chat_prompt</span><span class="p">:</span> <span class="n">ChatPromptTemplate</span><span class="p">,</span>
        <span class="n">llm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ChatOpenAI</span><span class="p">,</span> <span class="n">ChatAnthropic</span><span class="p">,</span> <span class="n">ChatGoogleGenerativeAI</span><span class="p">],</span>
        <span class="n">parser</span><span class="p">:</span> <span class="n">ParserType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fallback_parser</span><span class="p">:</span> <span class="n">FallbackParserType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_to_console</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">LOG_TO_CONSOLE</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a ChainBuilder instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            chat_prompt (ChatPromptTemplate): Template for structuring chat interactions.</span>
<span class="sd">            llm (Union[ChatOpenAI, ChatAnthropic, ChatGoogleGenerativeAI]): Language model to use.</span>
<span class="sd">            parser (ParserType | None): Primary output parser. Defaults to None.</span>
<span class="sd">            fallback_parser (FallbackParserType | None): Fallback output parser. Defaults to None.</span>
<span class="sd">            logger (logging.Logger | None): Custom logger instance. Defaults to None.</span>
<span class="sd">            log_to_console (bool | None): Whether to log to console. Defaults to LOG_TO_CONSOLE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">configure_logging</span><span class="p">(</span>
            <span class="n">module_name</span><span class="o">=</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">log_file_name</span><span class="o">=</span><span class="s2">&quot;chain_builder&quot;</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="n">DEBUG</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chat_prompt</span><span class="p">:</span> <span class="n">ChatPromptTemplate</span> <span class="o">=</span> <span class="n">chat_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ParserType</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback_parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FallbackParserType</span><span class="p">]</span> <span class="o">=</span> <span class="n">fallback_parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ChatOpenAI</span><span class="p">,</span> <span class="n">ChatAnthropic</span><span class="p">,</span> <span class="n">ChatGoogleGenerativeAI</span><span class="p">]</span> <span class="o">=</span> <span class="n">llm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">:</span> <span class="n">Runnable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_chain</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback_chain</span><span class="p">:</span> <span class="n">Runnable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_fallback_chain</span><span class="p">()</span></div>


<div class="viewcode-block" id="ChainBuilder.__str__">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainBuilder.__str__">[docs]</a>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string representation of the ChainBuilder object.</span>

<span class="sd">        The string includes the class names of the chat_prompt, llm, and parser attributes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the ChainBuilder object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ChainBuilder(chat_prompt=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chat_prompt</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, llm=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, parser=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="ChainBuilder.__repr__">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainBuilder.__repr__">[docs]</a>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string representation of the object for debugging purposes.</span>

<span class="sd">        This method calls the __str__() method to provide a human-readable</span>
<span class="sd">        representation of the object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span></div>


<div class="viewcode-block" id="ChainBuilder._run_pydantic_parser_logging">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainBuilder._run_pydantic_parser_logging">[docs]</a>
    <span class="k">def</span> <span class="nf">_run_pydantic_parser_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs the required fields and their default values (if any) for a Pydantic model</span>
<span class="sd">        if the parser is an instance of PydanticOutputParser. Additionally, logs the</span>
<span class="sd">        JSON schema of the Pydantic model.</span>

<span class="sd">        This method performs the following steps:</span>
<span class="sd">        1. Checks if the parser is an instance of PydanticOutputParser.</span>
<span class="sd">        2. Retrieves the Pydantic model from the parser.</span>
<span class="sd">        3. Logs each field&#39;s name and whether it is required or optional.</span>
<span class="sd">        4. Logs the default value of each field if it is not None.</span>
<span class="sd">        5. Logs the JSON schema of the Pydantic model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">,</span> <span class="n">PydanticOutputParser</span><span class="p">):</span>
            <span class="n">pydantic_model</span><span class="p">:</span> <span class="n">BaseModel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">pydantic_object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Required fields in Pydantic model:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">pydantic_model</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;required&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">field</span><span class="o">.</span><span class="n">is_required</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;optional&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Default: </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Model Schema:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">pydantic_model</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">())</span></div>


<div class="viewcode-block" id="ChainBuilder._build_chain">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainBuilder._build_chain">[docs]</a>
    <span class="k">def</span> <span class="nf">_build_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runnable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds and returns a chain of Runnable objects.</span>

<span class="sd">        The chain is constructed by combining a RunnablePassthrough object with</span>
<span class="sd">        the chat_prompt and llm attributes. If a parser is provided, it is added</span>
<span class="sd">        to the chain and pydantic parser logging is executed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Runnable: The constructed chain of Runnable objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build the chain</span>
        <span class="n">chain</span><span class="p">:</span> <span class="n">Runnable</span> <span class="o">=</span> <span class="n">RunnablePassthrough</span><span class="p">()</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_prompt</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_pydantic_parser_logging</span><span class="p">()</span>
            <span class="n">chain</span><span class="p">:</span> <span class="n">Runnable</span> <span class="o">=</span> <span class="n">chain</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span>

        <span class="k">return</span> <span class="n">chain</span></div>


<div class="viewcode-block" id="ChainBuilder._build_fallback_chain">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainBuilder._build_fallback_chain">[docs]</a>
    <span class="k">def</span> <span class="nf">_build_fallback_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runnable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds the fallback chain for the Runnable.</span>

<span class="sd">        This method constructs a fallback chain by combining a RunnablePassthrough</span>
<span class="sd">        instance with the chat prompt and language model (llm). If a fallback parser</span>
<span class="sd">        is provided, it adds the parser to the chain and logs the parser usage.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Runnable: The constructed fallback chain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fallback_chain</span><span class="p">:</span> <span class="n">Runnable</span> <span class="o">=</span> <span class="n">RunnablePassthrough</span><span class="p">()</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_prompt</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_parser</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_pydantic_parser_logging</span><span class="p">()</span>
            <span class="n">fallback_chain</span><span class="p">:</span> <span class="n">Runnable</span> <span class="o">=</span> <span class="n">fallback_chain</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_parser</span>

        <span class="k">return</span> <span class="n">fallback_chain</span></div>


<div class="viewcode-block" id="ChainBuilder.get_chain">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainBuilder.get_chain">[docs]</a>
    <span class="k">def</span> <span class="nf">get_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runnable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the current chain.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Runnable: The current chain instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span></div>


<div class="viewcode-block" id="ChainBuilder.get_fallback_chain">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainBuilder.get_fallback_chain">[docs]</a>
    <span class="k">def</span> <span class="nf">get_fallback_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runnable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the fallback chain.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Runnable: The fallback chain instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_chain</span></div>
</div>



<div class="viewcode-block" id="ChainWrapper">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainWrapper">[docs]</a>
<span class="k">class</span> <span class="nc">ChainWrapper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper class for managing and executing chains with optional fallback chains.</span>

<span class="sd">    This class is designed to handle the execution of primary chains and, if necessary,</span>
<span class="sd">    fallback chains in case of errors or unexpected outputs. It supports preprocessing</span>
<span class="sd">    and postprocessing of input and output data, as well as logging for debugging and</span>
<span class="sd">    monitoring purposes.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        chain (Runnable): The primary chain to be executed.</span>
<span class="sd">        fallback_chain (Runnable): The fallback chain to be executed if the primary chain fails.</span>
<span class="sd">        parser (Optional[ParserType]): The parser to be used for processing the output of the primary chain. Defaults to None.</span>
<span class="sd">        fallback_parser (Optional[FallbackParserType]): The parser to be used for processing the output of the fallback chain. Defaults to None.</span>
<span class="sd">        preprocessor (Optional[Callable[[Dict[str, Any]], Dict[str, Any]]]): A function to preprocess input data before passing it to the chain. Defaults to None.</span>
<span class="sd">        postprocessor (Optional[Callable[[Any], Any]]): A function to postprocess the output data from the chain. Defaults to None.</span>
<span class="sd">        logger (Optional[logging.Logger]): A logger instance for logging information and debugging. Defaults to None.</span>

<span class="sd">    Methods:</span>
<span class="sd">        __init__(chain, fallback_chain, parser=None, fallback_parser=None, preprocessor=None, postprocessor=None, logger=None): Initializes the ChainWrapper instance with the provided parameters.</span>
<span class="sd">        __str__(): Returns a string representation of the ChainWrapper object, including the chain, parser type, and fallback parser type.</span>
<span class="sd">        __repr__(): Returns a string representation of the ChainWrapper object for debugging purposes.</span>
<span class="sd">        run_chain(input_data=None, is_last_chain=False): Executes the primary chain with the provided input data. If an error occurs, attempts to execute the fallback chain. Supports preprocessing and postprocessing.</span>
<span class="sd">        get_parser_type(): Returns the type of the parser as a string if the parser exists, otherwise returns None.</span>
<span class="sd">        get_fallback_parser_type(): Returns the type of the fallback parser as a string if it exists, otherwise returns None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ChainWrapper.__init__">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainWrapper.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">chain</span><span class="p">:</span> <span class="n">Runnable</span><span class="p">,</span>
        <span class="n">fallback_chain</span><span class="p">:</span> <span class="n">Runnable</span><span class="p">,</span>
        <span class="n">parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ParserType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fallback_parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FallbackParserType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">preprocessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">postprocessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the ChainBuilder.</span>

<span class="sd">        Args:</span>
<span class="sd">            chain (Runnable): The primary chain to be executed.</span>
<span class="sd">            fallback_chain (Runnable): The fallback chain to be executed if the primary chain fails.</span>
<span class="sd">            parser (Optional[ParserType], optional): The parser to be used for the primary chain. Defaults to None.</span>
<span class="sd">            fallback_parser (Optional[FallbackParserType], optional): The parser to be used for the fallback chain. Defaults to None.</span>
<span class="sd">            preprocessor (Optional[Callable[[Dict[str, Any]], Dict[str, Any]]], optional): A function to preprocess input data before passing it to the chain. Defaults to None.</span>
<span class="sd">            postprocessor (Optional[Callable[[Any], Any]], optional): A function to postprocess the output data from the chain. Defaults to None.</span>
<span class="sd">            logger (Optional[logging.Logger], optional): A logger instance for logging information. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">configure_logging</span><span class="p">(</span>
            <span class="n">module_name</span><span class="o">=</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">log_file_name</span><span class="o">=</span><span class="s2">&quot;chain_wrapper&quot;</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="n">DEBUG</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ParserType</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback_parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FallbackParserType</span><span class="p">]</span> <span class="o">=</span> <span class="n">fallback_parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">preprocessor</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">:</span> <span class="n">Runnable</span> <span class="o">=</span> <span class="n">chain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback_chain</span><span class="p">:</span> <span class="n">Runnable</span> <span class="o">=</span> <span class="n">fallback_chain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postprocessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">postprocessor</span></div>


<div class="viewcode-block" id="ChainWrapper.__str__">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainWrapper.__str__">[docs]</a>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string representation of the ChainWrapper object.</span>

<span class="sd">        The string includes the chain, the type of the parser, and the type of the fallback parser.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the ChainWrapper object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ChainWrapper(chain=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="si">}</span><span class="s2">, parser=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">, fallback_parser=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fallback_parser</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">fallback_parser</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="ChainWrapper.__repr__">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainWrapper.__repr__">[docs]</a>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string representation of the object for debugging purposes.</span>

<span class="sd">        This method calls the __str__() method to provide a user-friendly string</span>
<span class="sd">        representation of the object. It is intended to be used for debugging</span>
<span class="sd">        and development, rather than for end-user display.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span></div>


<div class="viewcode-block" id="ChainWrapper.run_chain">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainWrapper.run_chain">[docs]</a>
    <span class="k">def</span> <span class="nf">run_chain</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_last_chain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the primary chain with the provided input data. If an error occurs in the primary chain,</span>
<span class="sd">        and a fallback chain is provided, it attempts to execute the fallback chain.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data (Dict[str, Any], optional): The input data required to run the chain. Defaults to None.</span>
<span class="sd">            is_last_chain (bool, optional): Indicates if this is the last chain in the sequence. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The output from the chain execution, potentially processed by a postprocessor.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If no input data is provided.</span>
<span class="sd">            json.JSONDecodeError: If a JSON decode error occurs in both the main and fallback chains.</span>
<span class="sd">            ValidationError: If a validation error occurs in both the main and fallback chains.</span>
<span class="sd">            TypeError: If a type error occurs in both the main and fallback chains.</span>

<span class="sd">        Notes:</span>
<span class="sd">        - If the output is a Pydantic model and this is not the last chain, the model is converted to a dictionary.</span>

<span class="sd">        - If a postprocessor is defined, it processes the output before returning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No input data provided to ChainWrapper.run_chain(). Input data is required to run the chain.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Attempt to invoke the primary chain</span>
            <span class="n">output</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span>
            <span class="n">ValidationError</span><span class="p">,</span>
            <span class="ne">ValueError</span><span class="p">,</span>
            <span class="ne">TypeError</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">main_chain_exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in main chain: </span><span class="si">{</span><span class="n">main_chain_exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to execute fallback chain&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_chain</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_last_chain</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fallback chain provided, executing fallback chain&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Attempt to invoke the fallback chain</span>
                    <span class="n">output</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span>
                    <span class="n">ValidationError</span><span class="p">,</span>
                    <span class="ne">ValueError</span><span class="p">,</span>
                    <span class="ne">TypeError</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">fallback_exception</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fallback_exception</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Error in fallback chain: </span><span class="si">{</span><span class="n">fallback_exception</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;A json decode error occurred in the main chain. Executing fallback chain. If you didn&#39;t provide a fallback chain it will not be ran, since it was a json decode error you should check how you&#39;re telling the LLM to output the json and make sure it matches your pydantic model. Additionally, LLMs will sometimes output invalid characters to json such as Latex code, leading to invalide escape sequences or characters. If this is the case you should try StrOutputParser() if it isn&#39;t your last chain layer. If it is your last chain layer, try simplifying your pydantic model and enhancing your prompt to avoid this issue. If you are using a LLM such as &#39;gpt-4o-mini&#39; or &#39;claude-3.5-haiku&#39; you may see better results with a larger model such as &#39;gpt-4o&#39; or &#39;claude-3.5-sonnet&#39;.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">raise</span> <span class="n">fallback_exception</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">main_chain_exception</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;A json decode error occurred in the main chain. Executing fallback chain. If you didn&#39;t provide a fallback chain it will not be ran, since it was a json decode error you should check how you&#39;re telling the LLM to output the json and make sure it matches your pydantic model. Additionally, LLMs will sometimes output invalid characters to json such as Latex code, leading to invalide escape sequences or characters. If this is the case you should try StrOutputParser() if it isn&#39;t your last chain layer. If it is your last chain layer, try simplifying your pydantic model and enhancing your prompt to avoid this issue. If you are using a LLM such as &#39;gpt-4o-mini&#39; or &#39;claude-3.5-haiku&#39; you may see better results with a larger model such as &#39;gpt-4o&#39; or &#39;claude-3.5-sonnet&#39;.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">main_chain_exception</span>

        <span class="c1"># Only need to handle intermediate chain Pydantic outputs</span>
        <span class="c1"># Rest are handled by JsonOutputParser or PydanticOutputParser</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_last_chain</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postprocessor</span><span class="p">:</span>
            <span class="n">output</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postprocessor</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="ChainWrapper.get_parser_type">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainWrapper.get_parser_type">[docs]</a>
    <span class="k">def</span> <span class="nf">get_parser_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the type of the parser as a string if the parser exists, otherwise returns None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[str, None]: The type of the parser as a string, or None if the parser does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ChainWrapper.get_fallback_parser_type">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainWrapper.get_fallback_parser_type">[docs]</a>
    <span class="k">def</span> <span class="nf">get_fallback_parser_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the type name of the fallback parser if it exists, otherwise returns None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[str, None]:</span>
<span class="sd">            - The type name of the fallback parser as a string if it exists, otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fallback_parser</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_parser</span> <span class="k">else</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="ChainComposer">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainComposer">[docs]</a>
<span class="k">class</span> <span class="nc">ChainComposer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages a sequence of chain operations.</span>

<span class="sd">    ChainComposer is a class that manages a sequence of chain operations, allowing for the addition of chains and running them in sequence with provided data.</span>


<span class="sd">    Methods:</span>
<span class="sd">        __init__(logger: Optional[logging.Logger] = None) -&gt; None:</span>
<span class="sd">            Initializes the ChainComposer instance with an optional logger.</span>

<span class="sd">        __str__() -&gt; str:</span>
<span class="sd">            Returns a string representation of the ChainComposer instance.</span>

<span class="sd">        __repr__() -&gt; str:</span>
<span class="sd">            Returns a string representation of the ChainComposer instance.</span>

<span class="sd">        add_chain(chain_wrapper: ChainWrapper, output_passthrough_key_name: Optional[str] = None) -&gt; None:</span>
<span class="sd">            Adds a chain to the chain sequence.</span>

<span class="sd">        run(data_dict: Dict[str, Any], data_dict_update_function: Optional[Callable[[Dict[str, Any]], None]] = None) -&gt; Dict[str, Any]:</span>
<span class="sd">        - Runs the chain sequence with the provided data dictionary and optional update function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ChainComposer.__init__">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainComposer.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the ChainBuilder instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            logger (Optional[logging.Logger]):</span>
<span class="sd">            - A logger instance to be used for logging.</span>

<span class="sd">            - If not provided, a default logger will be created.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            logger (logging.Logger): The logger instance used for logging.</span>
<span class="sd">            chain_sequence (List[Tuple[ChainWrapper, Optional[str]]]): A list to store the chain sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">configure_logging</span><span class="p">(</span>
            <span class="n">module_name</span><span class="o">=</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">log_file_name</span><span class="o">=</span><span class="s2">&quot;chain_composer&quot;</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="n">DEBUG</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chain_sequence</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ChainWrapper</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="ChainComposer.__str__">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainComposer.__str__">[docs]</a>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a string representation of the ChainComposer object.</span>

<span class="sd">        The string representation includes the index and the wrapper of each</span>
<span class="sd">        element in the chain_sequence.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the ChainComposer object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chain_info</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">wrapper</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_sequence</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ChainComposer(chains=[</span><span class="si">{</span><span class="n">chain_info</span><span class="si">}</span><span class="s2">])&quot;</span></div>


<div class="viewcode-block" id="ChainComposer.__repr__">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainComposer.__repr__">[docs]</a>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a string representation of the object for debugging purposes.</span>

<span class="sd">        This method calls the __str__() method to provide a human-readable</span>
<span class="sd">        representation of the object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span></div>


<div class="viewcode-block" id="ChainComposer.add_chain">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainComposer.add_chain">[docs]</a>
    <span class="k">def</span> <span class="nf">add_chain</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">chain_wrapper</span><span class="p">:</span> <span class="n">ChainWrapper</span><span class="p">,</span>
        <span class="n">output_passthrough_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a chain to the chain sequence.</span>

<span class="sd">        Args:</span>
<span class="sd">            chain_wrapper (ChainWrapper): The chain wrapper to be added.</span>
<span class="sd">            output_passthrough_key_name (Optional[str], optional): The key name for output passthrough. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">chain_wrapper</span><span class="p">,</span> <span class="n">output_passthrough_key_name</span><span class="p">))</span></div>


<div class="viewcode-block" id="ChainComposer.run">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainComposer.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">data_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">data_dict_update_function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes a sequence of chains, updating the provided data dictionary with the results of each chain.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_dict (Dict[str, Any]): The initial data dictionary containing input variables for the chains.</span>
<span class="sd">            data_dict_update_function (Optional[Callable[[Dict[str, Any]], None]]): An optional function to update the data dictionary after each chain execution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: The updated data dictionary after all chains have been executed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserWarning: If the provided data dictionary is empty.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - The method iterates over a sequence of chains (`self.chain_sequence`), executing each chain and updating the `data_dict` with the output.</span>
<span class="sd">            - If an `output_name` is provided for a chain, the output is stored in `data_dict` under that name; otherwise, it is stored under the key `_last_output`.</span>
<span class="sd">            - If `data_dict_update_function` is provided, it is called with the updated `data_dict` after each chain execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;No variables provided for the chain. Please ensure you have provided the necessary variables. If you have variable placeholders and do not pass them in it will result in an error.&quot;</span>
            <span class="p">)</span>

        <span class="n">num_chains</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_sequence</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">chain_wrapper</span><span class="p">,</span> <span class="n">output_name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_sequence</span><span class="p">):</span>
            <span class="n">is_last_chain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">index</span> <span class="o">==</span> <span class="n">num_chains</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">output</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">chain_wrapper</span><span class="o">.</span><span class="n">run_chain</span><span class="p">(</span>
                <span class="n">input_data</span><span class="o">=</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">is_last_chain</span><span class="o">=</span><span class="n">is_last_chain</span>
            <span class="p">)</span>

            <span class="c1"># Update data with the output</span>
            <span class="k">if</span> <span class="n">output_name</span><span class="p">:</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="n">output_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;_last_output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>

            <span class="k">if</span> <span class="n">data_dict_update_function</span><span class="p">:</span>
                <span class="n">data_dict_update_function</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data_dict</span></div>
</div>



<div class="viewcode-block" id="ChainManager">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager">[docs]</a>
<span class="k">class</span> <span class="nc">ChainManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class responsible for managing and orchestrating a sequence of chain layers,</span>

<span class="sd">    ChainManager is a class responsible for managing and orchestrating a sequence of chain layers,</span>
<span class="sd">    each of which can process input data and produce output data. It supports various types of</span>
<span class="sd">    language models (LLMs) and parsers, and allows for pre-processing and post-processing of data.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        api_key (str): The API key for accessing the LLM service.</span>
<span class="sd">        llm_model (str): The name of the LLM model to use.</span>
<span class="sd">        llm_model_type (str): The type of the LLM model (e.g., &quot;openai&quot;, &quot;anthropic&quot;, &quot;google&quot;).</span>
<span class="sd">        llm_temperature (float): The temperature setting for the LLM model.</span>
<span class="sd">        llm_kwargs (Dict[str, Any]): Additional keyword arguments for the LLM model.</span>
<span class="sd">        llm (Union[ChatOpenAI, ChatAnthropic, ChatGoogleGenerativeAI]): The initialized LLM instance.</span>
<span class="sd">        chain_composer (ChainComposer): The composer for managing the sequence of chain layers.</span>
<span class="sd">        chain_variables (Dict[str, Any]): A dictionary of variables used in the chain layers.</span>
<span class="sd">        chain_variables_update_overwrite_warning_counter (int): Counter for tracking variable overwrite warnings.</span>
<span class="sd">        preprocessor (Optional[Callable[[Dict[str, Any]], Dict[str, Any]]]): Optional preprocessor function.</span>
<span class="sd">        postprocessor (Optional[Callable[[Any], Any]]): Optional postprocessor function.</span>
<span class="sd">        logger (logging.Logger): Logger for logging information and debugging.</span>

<span class="sd">    Methods:</span>
<span class="sd">        __str__(): Returns a string representation of the ChainManager instance.</span>
<span class="sd">        __repr__(): Returns a string representation of the ChainManager instance.</span>
<span class="sd">        _get_llm_model_type(llm_model: str): Determines the type of the LLM model based on its name.</span>
<span class="sd">        _initialize_llm(api_key: str, llm_model_type: str, llm_model: str, llm_temperature: float, llm_kwargs: Dict[str, Any]): Initializes the LLM instance based on the model type.</span>
<span class="sd">        _create_openai_llm(api_key: str, llm_model: str, llm_temperature: float, llm_kwargs: Dict[str, Any]): Creates an OpenAI LLM instance.</span>
<span class="sd">        _create_anthropic_llm(api_key: str, llm_model: str, llm_temperature: float, llm_kwargs: Dict[str, Any]): Creates an Anthropic LLM instance.</span>
<span class="sd">        _create_google_llm(api_key: str, llm_model: str, llm_temperature: float, llm_kwargs: Dict[str, Any]): Creates a Google Generative AI LLM instance.</span>
<span class="sd">        _initialize_parser(parser_type: str, pydantic_output_model: Optional[BaseModel] = None): Initializes a parser based on the specified type.</span>
<span class="sd">        _create_pydantic_parser(pydantic_output_model: BaseModel): Creates a Pydantic parser.</span>
<span class="sd">        _create_json_parser(pydantic_output_model: Optional[BaseModel]): Creates a JSON parser.</span>
<span class="sd">        _create_str_parser(): Creates a string parser.</span>
<span class="sd">        _run_chain_validation_checks(output_passthrough_key_name: Optional[str], ignore_output_passthrough_key_name_error: bool, parser_type: Optional[Literal[&quot;pydantic&quot;, &quot;json&quot;, &quot;str&quot;]], pydantic_output_model: Optional[BaseModel], fallback_parser_type: Optional[Literal[&quot;pydantic&quot;, &quot;json&quot;, &quot;str&quot;]], fallback_pydantic_output_model: Optional[BaseModel]): Runs validation checks for the chain configuration.</span>
<span class="sd">        _format_chain_sequence(chain_sequence: List[Tuple[ChainWrapper, Optional[str]]]): Formats and prints the chain sequence.</span>
<span class="sd">        _run_validation_checks(prompt_variables_dict: Union[FirstCallRequired, None]): Runs validation checks for the prompt variables.</span>
<span class="sd">        add_chain_layer(system_prompt: str, human_prompt: str, output_passthrough_key_name: Optional[str] = None, ignore_output_passthrough_key_name_error: bool = False, preprocessor: Optional[Callable[[Dict[str, Any]], Dict[str, Any]]] = None, postprocessor: Optional[Callable[[Any], Any]] = None, parser_type: Optional[Literal[&quot;pydantic&quot;, &quot;json&quot;, &quot;str&quot;]] = None, fallback_parser_type: Optional[Literal[&quot;pydantic&quot;, &quot;json&quot;, &quot;str&quot;]] = None, pydantic_output_model: Optional[BaseModel] = None, fallback_pydantic_output_model: Optional[BaseModel] = None): Adds a chain layer to the chain composer.</span>
<span class="sd">        _format_overwrite_warning(overwrites: Dict[str, Dict[str, Any]]): Formats a warning message for variable overwrites.</span>
<span class="sd">        _check_first_time_overwrites(prompt_variables_dict: Dict[str, Any]): Checks for first-time overwrites of global variables and issues warnings.</span>
<span class="sd">        _update_chain_variables(prompt_variables_dict: Dict[str, Any]): Updates global variables with new values, warning on first-time overwrites.</span>
<span class="sd">        get_chain_sequence(): Returns the current chain sequence.</span>
<span class="sd">        print_chain_sequence(): Prints the current chain sequence.</span>
<span class="sd">        get_chain_variables(): Returns the current chain variables.</span>
<span class="sd">        print_chain_variables(): Prints the current chain variables.</span>
<span class="sd">        run(prompt_variables_dict: Union[FirstCallRequired, None] = None): Runs the chain composer with the provided prompt variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ChainManager.__init__">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">llm_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">llm_temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
        <span class="n">preprocessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">postprocessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_to_console</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">llm_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">words_to_ban</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the ChainBuilder class.</span>

<span class="sd">        Args:</span>
<span class="sd">            llm_model (str): The name of the language model to be used.</span>
<span class="sd">            api_key (str): The API key for accessing the language model.</span>
<span class="sd">            llm_temperature (float, optional): The temperature setting for the language model. Defaults to 0.7.</span>
<span class="sd">            preprocessor (Optional[Callable[[Dict[str, Any]], Dict[str, Any]]], optional): A function to preprocess input data. Defaults to None.</span>
<span class="sd">            postprocessor (Optional[Callable[[Any], Any]], optional): A function to postprocess output data. Defaults to None.</span>
<span class="sd">            log_to_console (bool, optional): Flag to enable logging to console. Defaults to False.</span>
<span class="sd">            llm_kwargs (Dict[str, Any]): Additional keyword arguments for the language model.</span>
<span class="sd">            words_to_ban (List[str]): A list of words to ban from the language model&#39;s output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_to_console</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">log_to_console</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">configure_logging</span><span class="p">(</span>
            <span class="n">module_name</span><span class="o">=</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">log_file_name</span><span class="o">=</span><span class="s2">&quot;chain_builder&quot;</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="n">DEBUG</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">llm_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">llm_kwargs</span> <span class="k">if</span> <span class="n">llm_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">llm_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm_model_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_llm_model_type</span><span class="p">(</span><span class="n">llm_model</span><span class="o">=</span><span class="n">llm_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">words_to_ban</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">words_to_ban</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logit_bias_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">words_to_ban</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_words_to_ban</span><span class="p">(</span><span class="n">words_to_ban</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">words_to_ban</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logit_bias_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logit_bias_dict</span><span class="p">(</span>
                <span class="n">llm_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing LLM: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">llm_kwargs</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">llm_temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">llm_temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ChatOpenAI</span><span class="p">,</span> <span class="n">ChatAnthropic</span><span class="p">,</span> <span class="n">ChatGoogleGenerativeAI</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_llm</span><span class="p">(</span>
                <span class="n">api_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                <span class="n">llm_model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_model_type</span><span class="p">,</span>
                <span class="n">llm_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span><span class="p">,</span>
                <span class="n">llm_temperature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_temperature</span><span class="p">,</span>
                <span class="n">llm_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_kwargs</span><span class="p">,</span>
                <span class="n">logit_bias_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logit_bias_dict</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized LLM: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing ChainComposer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_composer</span><span class="p">:</span> <span class="n">ChainComposer</span> <span class="o">=</span> <span class="n">ChainComposer</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized ChainComposer: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_composer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing Chain Variables&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized Chain Variables: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_variables</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chain_variables_update_overwrite_warning_counter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing Preprocessor </span><span class="si">{</span><span class="n">preprocessor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">preprocessor</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized Preprocessor: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing Postprocessor </span><span class="si">{</span><span class="n">postprocessor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postprocessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">postprocessor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized Postprocessor: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">postprocessor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager.__str__">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager.__str__">[docs]</a>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string representation of the ChainManager object.</span>

<span class="sd">        The string includes the values of the &#39;llm&#39;, &#39;chain_composer&#39;, and &#39;global_variables&#39; attributes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the ChainManager object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ChainManager(llm=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="si">}</span><span class="s2">, chain_composer=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_composer</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;global_variables=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">global_variables</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager.__repr__">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager.__repr__">[docs]</a>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string representation of the object for debugging purposes.</span>

<span class="sd">        This method calls the __str__() method to provide a user-friendly string</span>
<span class="sd">        representation of the object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span></div>


<div class="viewcode-block" id="ChainManager._validate_words_to_ban">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._validate_words_to_ban">[docs]</a>
    <span class="k">def</span> <span class="nf">_validate_words_to_ban</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words_to_ban</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the words to ban list.</span>

<span class="sd">        Args:</span>
<span class="sd">            words_to_ban (List[str]): The list of words to ban.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">words_to_ban</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;words_to_ban must be a list of strings&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words_to_ban</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;words_to_ban must be a list of strings&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Words to ban: </span><span class="si">{</span><span class="n">words_to_ban</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_model_type</span> <span class="o">!=</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;words_to_ban is currently only supported for OpenAI models&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;words_to_ban is currently only supported for gpt-4o and gpt-4o-mini&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager._get_logit_bias_dict">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._get_logit_bias_dict">[docs]</a>
    <span class="k">def</span> <span class="nf">_get_logit_bias_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the logit bias dictionary for the words to ban.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Getting logit bias dict for words to ban: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">words_to_ban</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Get the tokenizer for gpt-4o and gpt-4o-mini</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">get_encoding</span><span class="p">(</span><span class="s2">&quot;o200k_base&quot;</span><span class="p">)</span>

        <span class="n">logit_bias</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">words_to_ban</span><span class="p">:</span>
            <span class="n">token_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Word to ban &#39;</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s2">&#39; has multiple tokens: </span><span class="si">{</span><span class="n">token_ids</span><span class="si">}</span><span class="s2">, all tokens will be banned&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Apply -100 bias to each token</span>
            <span class="k">for</span> <span class="n">token_id</span> <span class="ow">in</span> <span class="n">token_ids</span><span class="p">:</span>
                <span class="n">logit_bias</span><span class="p">[</span><span class="n">token_id</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>

        <span class="k">return</span> <span class="n">logit_bias</span></div>


<div class="viewcode-block" id="ChainManager._get_llm_model_type">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._get_llm_model_type">[docs]</a>
    <span class="k">def</span> <span class="nf">_get_llm_model_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">llm_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the type of LLM (Large Language Model) based on the provided model name.</span>

<span class="sd">        Args:</span>
<span class="sd">            llm_model (str): The name of the LLM model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The type of the LLM model. Possible values are &quot;openai&quot;, &quot;anthropic&quot;, and &quot;google&quot;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the provided LLM model name does not match any of the supported types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">llm_model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gpt&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;openai&quot;</span>
        <span class="k">elif</span> <span class="n">llm_model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;claude&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;anthropic&quot;</span>
        <span class="k">elif</span> <span class="n">llm_model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gemini&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;google&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported LLM model: </span><span class="si">{</span><span class="n">llm_model</span><span class="si">}</span><span class="s2">. Supported types: gpt, claude, gemini.&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager._initialize_llm">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._initialize_llm">[docs]</a>
    <span class="k">def</span> <span class="nf">_initialize_llm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">llm_model_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">llm_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">llm_temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">llm_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">logit_bias_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">ChatOpenAI</span><span class="p">,</span> <span class="n">ChatAnthropic</span><span class="p">,</span> <span class="n">ChatGoogleGenerativeAI</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a language model based on the specified type.</span>

<span class="sd">        Args:</span>
<span class="sd">            api_key (str): The API key for accessing the language model service.</span>
<span class="sd">            llm_model_type (str): The type of the language model (e.g., &quot;openai&quot;, &quot;anthropic&quot;, &quot;google&quot;).</span>
<span class="sd">            llm_model (str): The specific model to use within the chosen type.</span>
<span class="sd">            llm_temperature (float): The temperature setting for the language model, affecting randomness.</span>
<span class="sd">            llm_kwargs (Dict[str, Any]): Additional keyword arguments specific to the language model.</span>
<span class="sd">            logit_bias_dict (Dict[int, int]): A dictionary mapping token IDs to logit bias values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[ChatOpenAI, ChatAnthropic, ChatGoogleGenerativeAI]: An instance of the initialized language model.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the specified `llm_model_type` is not supported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span>

        <span class="k">if</span> <span class="n">llm_model_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">llm_model_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_model_type</span>

        <span class="k">if</span> <span class="n">llm_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">llm_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span>

        <span class="k">if</span> <span class="n">llm_temperature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">llm_temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_temperature</span>

        <span class="k">if</span> <span class="n">llm_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">llm_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_kwargs</span>

        <span class="k">if</span> <span class="n">llm_model_type</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_openai_llm</span><span class="p">(</span>
                <span class="n">api_key</span><span class="p">,</span> <span class="n">llm_model</span><span class="p">,</span> <span class="n">llm_temperature</span><span class="p">,</span> <span class="n">llm_kwargs</span><span class="p">,</span> <span class="n">logit_bias_dict</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">llm_model_type</span> <span class="o">==</span> <span class="s2">&quot;anthropic&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_anthropic_llm</span><span class="p">(</span>
                <span class="n">api_key</span><span class="p">,</span> <span class="n">llm_model</span><span class="p">,</span> <span class="n">llm_temperature</span><span class="p">,</span> <span class="o">**</span><span class="n">llm_kwargs</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">llm_model_type</span> <span class="o">==</span> <span class="s2">&quot;google&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_google_llm</span><span class="p">(</span>
                <span class="n">api_key</span><span class="p">,</span> <span class="n">llm_model</span><span class="p">,</span> <span class="n">llm_temperature</span><span class="p">,</span> <span class="o">**</span><span class="n">llm_kwargs</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported LLM model type: </span><span class="si">{</span><span class="n">llm_model_type</span><span class="si">}</span><span class="s2">. Supported types: openai, anthropic, google.&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager._recreate_llm">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._recreate_llm">[docs]</a>
    <span class="k">def</span> <span class="nf">_recreate_llm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recreates the LLM with the current parameters.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_llm</span><span class="p">(</span>
            <span class="n">api_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">llm_model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_model_type</span><span class="p">,</span>
            <span class="n">llm_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span><span class="p">,</span>
            <span class="n">llm_temperature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_temperature</span><span class="p">,</span>
            <span class="n">llm_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_kwargs</span><span class="p">,</span>
            <span class="n">logit_bias_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logit_bias_dict</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager._create_openai_llm">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._create_openai_llm">[docs]</a>
    <span class="k">def</span> <span class="nf">_create_openai_llm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">llm_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">llm_temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">llm_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">logit_bias_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatOpenAI</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of the ChatOpenAI language model.</span>

<span class="sd">        Args:</span>
<span class="sd">            api_key (str): The API key for authenticating with the OpenAI service.</span>
<span class="sd">            llm_model (str): The identifier of the language model to use.</span>
<span class="sd">            llm_temperature (float): The temperature setting for the language model, which controls the randomness of the output.</span>
<span class="sd">            llm_kwargs (Dict[str, Any]): Additional keyword arguments to pass to the ChatOpenAI constructor.</span>
<span class="sd">            logit_bias_dict (Dict[int, int]): A dictionary mapping token IDs to logit bias values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ChatOpenAI: An instance of the ChatOpenAI language model configured with the specified parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">llm_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request_timeout&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">llm_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ChatOpenAI</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">llm_model</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="n">llm_temperature</span><span class="p">,</span>
            <span class="n">request_timeout</span><span class="o">=</span><span class="n">request_timeout</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="o">=</span><span class="n">max_retries</span><span class="p">,</span>
            <span class="n">logit_bias</span><span class="o">=</span><span class="n">logit_bias_dict</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager._create_anthropic_llm">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._create_anthropic_llm">[docs]</a>
    <span class="k">def</span> <span class="nf">_create_anthropic_llm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">**</span><span class="n">llm_kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatAnthropic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of the ChatAnthropic language model.</span>

<span class="sd">        Args:</span>
<span class="sd">            api_key (str): The API key for authenticating with the Anthropic service.</span>
<span class="sd">            llm_model (str): The identifier of the language model to use.</span>
<span class="sd">            llm_temperature (float): The temperature setting for the language model, controlling the randomness of the output.</span>
<span class="sd">            llm_kwargs (Dict[str, Any]): Additional keyword arguments to pass to the ChatAnthropic constructor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ChatAnthropic: An instance of the ChatAnthropic language model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ChatAnthropic</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">llm_model</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">llm_temperature</span><span class="p">,</span> <span class="o">**</span><span class="n">llm_kwargs</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager._create_google_llm">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._create_google_llm">[docs]</a>
    <span class="k">def</span> <span class="nf">_create_google_llm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">**</span><span class="n">llm_kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatGoogleGenerativeAI</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of ChatGoogleGenerativeAI with the specified parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            api_key (str): The API key for authenticating with the Google LLM service.</span>
<span class="sd">            llm_model (str): The model identifier for the Google LLM.</span>
<span class="sd">            llm_temperature (float): The temperature setting for the LLM, which controls the randomness of the output.</span>
<span class="sd">            llm_kwargs (Dict[str, Any]): Additional keyword arguments to pass to the ChatGoogleGenerativeAI constructor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ChatGoogleGenerativeAI: An instance of the ChatGoogleGenerativeAI class configured with the provided parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ChatGoogleGenerativeAI</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">llm_model</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">llm_temperature</span><span class="p">,</span> <span class="o">**</span><span class="n">llm_kwargs</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager._initialize_parser">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._initialize_parser">[docs]</a>
    <span class="k">def</span> <span class="nf">_initialize_parser</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">parser_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pydantic_output_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParserType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes and returns a parser based on the specified parser type.</span>

<span class="sd">        Args:</span>
<span class="sd">            parser_type (str):</span>
<span class="sd">            - The type of parser to initialize.</span>

<span class="sd">            - Must be one of &quot;pydantic&quot;, &quot;json&quot;, or &quot;str&quot;.</span>

<span class="sd">            pydantic_output_model (Optional[BaseModel]):</span>
<span class="sd">            - The Pydantic model to use for the parser.</span>

<span class="sd">            - Required if parser_type is &quot;pydantic&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ParserType: An instance of the specified parser type.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If an invalid parser_type is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parser_type</span> <span class="o">==</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">:</span>
            <span class="n">parser</span><span class="p">:</span> <span class="n">PydanticOutputParser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_pydantic_parser</span><span class="p">(</span>
                <span class="n">pydantic_output_model</span><span class="o">=</span><span class="n">pydantic_output_model</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created Pydantic parser: </span><span class="si">{</span><span class="n">parser</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">parser</span>
        <span class="k">elif</span> <span class="n">parser_type</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
            <span class="n">parser</span><span class="p">:</span> <span class="n">JsonOutputParser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_json_parser</span><span class="p">(</span>
                <span class="n">pydantic_output_model</span><span class="o">=</span><span class="n">pydantic_output_model</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created JSON parser: </span><span class="si">{</span><span class="n">parser</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">parser</span>
        <span class="k">elif</span> <span class="n">parser_type</span> <span class="o">==</span> <span class="s2">&quot;str&quot;</span><span class="p">:</span>
            <span class="n">parser</span><span class="p">:</span> <span class="n">StrOutputParser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_str_parser</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created Str parser: </span><span class="si">{</span><span class="n">parser</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">parser</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid parser_type: </span><span class="si">{</span><span class="n">parser_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager._create_pydantic_parser">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._create_pydantic_parser">[docs]</a>
    <span class="k">def</span> <span class="nf">_create_pydantic_parser</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">pydantic_output_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PydanticOutputParser</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a Pydantic output parser.</span>

<span class="sd">        Args:</span>
<span class="sd">            pydantic_output_model (Optional[BaseModel]): The Pydantic model to be used for parsing output.</span>
<span class="sd">                Must be provided for &#39;pydantic&#39; parser_type.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PydanticOutputParser: An instance of PydanticOutputParser initialized with the provided Pydantic model.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If pydantic_output_model is not provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pydantic_output_model</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;pydantic_output_model must be provided for &#39;pydantic&#39; parser_type.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">PydanticOutputParser</span><span class="p">(</span><span class="n">pydantic_object</span><span class="o">=</span><span class="n">pydantic_output_model</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager._create_json_parser">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._create_json_parser">[docs]</a>
    <span class="k">def</span> <span class="nf">_create_json_parser</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">pydantic_output_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JsonOutputParser</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a JSON parser for the chain layer output.</span>

<span class="sd">        Args:</span>
<span class="sd">            pydantic_output_model (Optional[BaseModel]): An optional Pydantic model to enforce typing on the JSON output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            JsonOutputParser: An instance of JsonOutputParser. If pydantic_output_model is provided, the parser will enforce the model&#39;s schema on the output.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserWarning: If pydantic_output_model is not provided, a warning is issued recommending its use for proper typing of the output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JsonOutputParser</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pydantic_output_model</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;It is highly recommended to provide a pydantic_output_model when parser_type is &#39;json&#39;. &quot;</span>
                <span class="s2">&quot;This will ensure that the output of the chain layer is properly typed and can be used in downstream chain layers.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating JSON parser without pydantic_output_model. &quot;</span><span class="p">)</span>
            <span class="n">json_parser</span> <span class="o">=</span> <span class="n">JsonOutputParser</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Creating JSON parser with pydantic_output_model: </span><span class="si">{</span><span class="n">pydantic_output_model</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">json_parser</span> <span class="o">=</span> <span class="n">JsonOutputParser</span><span class="p">(</span><span class="n">pydantic_object</span><span class="o">=</span><span class="n">pydantic_output_model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json_parser</span></div>


<div class="viewcode-block" id="ChainManager._create_str_parser">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._create_str_parser">[docs]</a>
    <span class="k">def</span> <span class="nf">_create_str_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StrOutputParser</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of StrOutputParser.</span>

<span class="sd">        Returns:</span>
<span class="sd">            StrOutputParser: An instance of the StrOutputParser class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">StrOutputParser</span><span class="p">()</span></div>


<div class="viewcode-block" id="ChainManager._run_chain_validation_checks">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._run_chain_validation_checks">[docs]</a>
    <span class="k">def</span> <span class="nf">_run_chain_validation_checks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">output_passthrough_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">ignore_output_passthrough_key_name_error</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">parser_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pydantic&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;str&quot;</span><span class="p">]],</span>
        <span class="n">pydantic_output_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span>
        <span class="n">fallback_parser_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pydantic&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;str&quot;</span><span class="p">]],</span>
        <span class="n">fallback_pydantic_output_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validates chain configuration parameters before execution.</span>

<span class="sd">        Performs validation checks on chain configuration parameters to ensure proper setup</span>
<span class="sd">        and compatibility between different components.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_passthrough_key_name: Optional key name for passing chain output to next layer.</span>
<span class="sd">            ignore_output_passthrough_key_name_error: Whether to ignore missing output key name.</span>
<span class="sd">            parser_type: Type of parser to use (&quot;pydantic&quot;, &quot;json&quot;, or &quot;str&quot;).</span>
<span class="sd">            pydantic_output_model: Pydantic model for output validation.</span>
<span class="sd">            fallback_parser_type: Type of fallback parser.</span>
<span class="sd">            fallback_pydantic_output_model: Pydantic model for fallback parser.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If validation fails for:</span>
<span class="sd">            - Missing output key name when required</span>

<span class="sd">            - Invalid parser type combinations</span>

<span class="sd">            - Missing required models</span>

<span class="sd">            - Duplicate parser types</span>

<span class="sd">            - Same models used for main and fallback</span>

<span class="sd">        Warnings:</span>
<span class="sd">            UserWarning: For non-critical issues like:</span>
<span class="sd">            - Missing output key name when ignored</span>

<span class="sd">            - Missing recommended Pydantic models</span>

<span class="sd">            - Unused provided models</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_composer</span><span class="o">.</span><span class="n">chain_sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">output_passthrough_key_name</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_output_passthrough_key_name_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;output_passthrough_key_name not provided and ignore_output_passthrough_key_name_error is False. output_passthrough_key_name is required to identify the output of the chain layer in order to pass the output to the next chain layer. If you do not specify output_passthrough_key_name, the output of the chain layer will not be assigned to a variable and thus will not be available to the next chain layer. If you do not need the output of the chain layer to be passed to the next chain layer, you can set ignore_output_passthrough_key_name_error to True.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;output_passthrough_key_name not provided when adding a chain layer after another. Output of the chain layer will not be assigned to a variable.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">parser_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fallback_parser_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;parser_type is None when fallback_parser_type is not None. This is not allowed.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">parser_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pydantic_output_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">fallback_parser_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">fallback_pydantic_output_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">pydantic_output_model</span> <span class="o">==</span> <span class="n">fallback_pydantic_output_model</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;pydantic_output_model and fallback_pydantic_output_model are the same. This is not allowed.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">parser_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parser_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pydantic&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;str&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unsupported parser type: </span><span class="si">{</span><span class="n">parser_type</span><span class="si">}</span><span class="s2">. Supported types:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">PydanticOutputParser</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">JsonOutputParser</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">StrOutputParser</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">parser_type</span> <span class="o">==</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pydantic_output_model</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;pydantic_output_model must be specified when parser_type is &#39;pydantic&#39;.&quot;</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">parser_type</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pydantic_output_model</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;It is highly recommended to provide a pydantic_output_model when parser_type is &#39;json&#39;. &quot;</span>
                        <span class="s2">&quot;This will ensure that the output of the chain layer is properly typed and can be used in downstream chain layers.&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pydantic_output_model</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;pydantic_output_model is provided but parser_type is None. The pydantic_output_model will not be used.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">fallback_parser_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parser_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fallback_parser_type</span> <span class="o">==</span> <span class="n">parser_type</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;parser_type and fallback_parser_type are the same. This is not allowed.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">fallback_parser_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pydantic&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;str&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unsupported fallback_parser_type: </span><span class="si">{</span><span class="n">fallback_parser_type</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">fallback_parser_type</span> <span class="o">==</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fallback_pydantic_output_model</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;fallback_pydantic_output_model must be specified when fallback_parser_type is &#39;pydantic&#39;.&quot;</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">fallback_parser_type</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fallback_pydantic_output_model</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;It is highly recommended to provide a fallback_pydantic_output_model when fallback_parser_type is &#39;json&#39;. &quot;</span>
                        <span class="s2">&quot;This will ensure that the output of the fallback chain layer is properly typed and can be used in downstream chain layers.&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fallback_pydantic_output_model</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;fallback_pydantic_output_model is provided but fallback_parser_type is None. The fallback_pydantic_output_model will not be used.&quot;</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager._format_chain_sequence">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._format_chain_sequence">[docs]</a>
    <span class="k">def</span> <span class="nf">_format_chain_sequence</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">chain_sequence</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ChainWrapper</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formats and prints the details of each chain in the given chain sequence.</span>

<span class="sd">        Args:</span>
<span class="sd">            chain_sequence (List[Tuple[ChainWrapper, Optional[str]]]):</span>
<span class="sd">            - A list of tuples where each tuple contains a ChainWrapper object and an optional output name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">chain_wrapper</span><span class="p">,</span> <span class="n">output_name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chain_sequence</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chain </span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Output Name: </span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Parser Type: </span><span class="si">{</span><span class="n">chain_wrapper</span><span class="o">.</span><span class="n">get_parser_type</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Fallback Parser Type: </span><span class="si">{</span><span class="n">chain_wrapper</span><span class="o">.</span><span class="n">get_fallback_parser_type</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Preprocessor: </span><span class="si">{</span><span class="n">chain_wrapper</span><span class="o">.</span><span class="n">preprocessor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Postprocessor: </span><span class="si">{</span><span class="n">chain_wrapper</span><span class="o">.</span><span class="n">postprocessor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager._run_validation_checks">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._run_validation_checks">[docs]</a>
    <span class="k">def</span> <span class="nf">_run_validation_checks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">prompt_variables_dict</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">FirstCallRequired</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the input parameters for the chain execution.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt_variables_dict : Union[FirstCallRequired, None]</span>
<span class="sd">                A dictionary containing the variables to be passed to the chain layers.</span>
<span class="sd">                - On the first call to `run()`, this parameter must be provided.</span>
<span class="sd">                - On subsequent calls, it can be omitted if there are no new variables to pass.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">            - If `prompt_variables_dict` is None on the first call to `run()`.</span>

<span class="sd">            TypeError:</span>
<span class="sd">            - If `prompt_variables_dict` is not a dictionary when provided.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - The `prompt_variables_dict` should contain keys that match the variable names used in the chain layers.</span>
<span class="sd">            - The `output_passthrough_key_name` parameter in the `add_chain_layer` method is used to identify the output of the chain layer and assign it to a variable.</span>
<span class="sd">            - If `output_passthrough_key_name` is not specified, the output of the chain layer will not be assigned to a variable and will not be available to the next chain layer.</span>
<span class="sd">            - The `ignore_output_passthrough_key_name_error` parameter can be set to True if the output of the chain layer is not needed for the next chain layer, such as when running a chain layer solely for its side effects or if it is the last chain layer in a multi-layer chain.</span>
<span class="sd">            - Ensure that the placeholder variable names in your prompt strings match the keys in `prompt_variables_dict` passed into the `ChainManager.run()` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain_variables_update_overwrite_warning_counter</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">prompt_variables_dict</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;First call to run() must provide a prompt_variables_dict, otherwise there are no variables to pass to the chain layers. &quot;</span>
                <span class="s2">&quot;If you do not need to pass variables to the chain layers, you can set prompt_variables_dict to an empty dictionary. &quot;</span>
                <span class="s2">&quot;Subsequent calls to run() can omit prompt_variables_dict if you have no new variables to pass to the chain layers. &quot;</span>
                <span class="s2">&quot;This is because a global_variables dictionary is maintained in the ChainManager instance and is updated with each call to the class instance method _update_global_variables(), which is automatically called by run() when a new prompt_variables_dict is provided. &quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">prompt_variables_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">prompt_variables_dict</span><span class="p">),</span> <span class="nb">dict</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;prompt_variables_dict must be a dictionary. &quot;</span>
                <span class="s2">&quot;Each key should match the variable names used in your chain layers. &quot;</span>
                <span class="s2">&quot;output_passthrough_key_name parameter in add_chain_layer method is used to identify the output of the chain layer &quot;</span>
                <span class="s2">&quot;and assign it to a variable. If you do not specify output_passthrough_key_name, the output of the chain layer will not be assigned to a variable and thus will not be available to the next chain layer. &quot;</span>
                <span class="s2">&quot;If you do not need the output of the chain layer to be passed to the next chain layer, you can set ignore_output_passthrough_key_name_error to True. &quot;</span>
                <span class="s2">&quot;A time to set ignore_output_passthrough_key_name_error to True is when you are running a chain layer solely for its side effects (e.g. printing, saving to a database, etc.) without needing the output of the chain layer to be passed to the next chain layer. &quot;</span>
                <span class="s2">&quot;Another reason to set ignore_output_passthrough_key_name_error to True is if you have a multi-layer chain and this is your last chain layer. &quot;</span>
                <span class="s2">&quot;Check your prompt strings for your placeholder variables, these names should match the keys in prompt_variables_dict passed into the ChainManager.run() method.&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager.add_chain_layer">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager.add_chain_layer">[docs]</a>
    <span class="k">def</span> <span class="nf">add_chain_layer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">human_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_passthrough_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_output_passthrough_key_name_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">preprocessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">postprocessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parser_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pydantic&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;str&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fallback_parser_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pydantic&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;str&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pydantic_output_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fallback_pydantic_output_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a chain layer to the chain composer.</span>

<span class="sd">        This method configures and adds a new chain layer to the chain composer,</span>
<span class="sd">        allowing for the processing of input data through specified prompts and parsers.</span>

<span class="sd">        Args:</span>
<span class="sd">            system_prompt (str): The system prompt template for the chain layer.</span>
<span class="sd">            human_prompt (str): The human prompt template for the chain layer.</span>
<span class="sd">            output_passthrough_key_name (Optional[str]): Key name for passing chain output to the next layer.</span>
<span class="sd">            ignore_output_passthrough_key_name_error (bool): Flag to ignore missing output key name errors.</span>
<span class="sd">            preprocessor (Optional[Callable[[Dict[str, Any]], Dict[str, Any]]]): Function to preprocess input data.</span>
<span class="sd">            postprocessor (Optional[Callable[[Any], Any]]): Function to postprocess output data.</span>
<span class="sd">            parser_type (Optional[Literal[&quot;pydantic&quot;, &quot;json&quot;, &quot;str&quot;]]): Type of parser to use.</span>
<span class="sd">            fallback_parser_type (Optional[Literal[&quot;pydantic&quot;, &quot;json&quot;, &quot;str&quot;]]): Type of fallback parser.</span>
<span class="sd">            pydantic_output_model (Optional[BaseModel]): Pydantic model for output validation.</span>
<span class="sd">            fallback_pydantic_output_model (Optional[BaseModel]): Pydantic model for fallback parser.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Adding chain layer with output_passthrough_key_name: </span><span class="si">{</span><span class="n">output_passthrough_key_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ignore_output_passthrough_key_name_error: </span><span class="si">{</span><span class="n">ignore_output_passthrough_key_name_error</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parser_type: </span><span class="si">{</span><span class="n">parser_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pydantic_output_model: </span><span class="si">{</span><span class="n">pydantic_output_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;preprocessor: </span><span class="si">{</span><span class="n">preprocessor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;postprocessor: </span><span class="si">{</span><span class="n">postprocessor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;--------------------------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;system_prompt: </span><span class="si">{</span><span class="n">system_prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;human_prompt: </span><span class="si">{</span><span class="n">human_prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;--------------------------------&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_run_chain_validation_checks</span><span class="p">(</span>
            <span class="n">output_passthrough_key_name</span><span class="o">=</span><span class="n">output_passthrough_key_name</span><span class="p">,</span>
            <span class="n">ignore_output_passthrough_key_name_error</span><span class="o">=</span><span class="n">ignore_output_passthrough_key_name_error</span><span class="p">,</span>
            <span class="n">parser_type</span><span class="o">=</span><span class="n">parser_type</span><span class="p">,</span>
            <span class="n">pydantic_output_model</span><span class="o">=</span><span class="n">pydantic_output_model</span><span class="p">,</span>
            <span class="n">fallback_parser_type</span><span class="o">=</span><span class="n">fallback_parser_type</span><span class="p">,</span>
            <span class="n">fallback_pydantic_output_model</span><span class="o">=</span><span class="n">fallback_pydantic_output_model</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ParserType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fallback_parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ParserType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">parser_type</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_parser</span><span class="p">(</span>
                <span class="n">parser_type</span><span class="o">=</span><span class="n">parser_type</span><span class="p">,</span> <span class="n">pydantic_output_model</span><span class="o">=</span><span class="n">pydantic_output_model</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">fallback_parser_type</span><span class="p">:</span>
            <span class="n">fallback_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_parser</span><span class="p">(</span>
                <span class="n">parser_type</span><span class="o">=</span><span class="n">fallback_parser_type</span><span class="p">,</span>
                <span class="n">pydantic_output_model</span><span class="o">=</span><span class="n">fallback_pydantic_output_model</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># Create prompt templates without specifying input_variables</span>
        <span class="n">system_prompt_template</span><span class="p">:</span> <span class="n">PromptTemplate</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">)</span>
        <span class="n">human_prompt_template</span><span class="p">:</span> <span class="n">PromptTemplate</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">human_prompt</span><span class="p">)</span>
        <span class="n">system_message_prompt_template</span><span class="p">:</span> <span class="n">SystemMessagePromptTemplate</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">SystemMessagePromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="n">system_prompt_template</span><span class="o">.</span><span class="n">template</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">human_message_prompt_template</span><span class="p">:</span> <span class="n">HumanMessagePromptTemplate</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">HumanMessagePromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="n">human_prompt_template</span><span class="o">.</span><span class="n">template</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">chat_prompt_template</span><span class="p">:</span> <span class="n">ChatPromptTemplate</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">(</span>
            <span class="p">[</span><span class="n">system_message_prompt_template</span><span class="p">,</span> <span class="n">human_message_prompt_template</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Build the chain using ChainBuilder</span>
        <span class="n">chain_builder</span><span class="p">:</span> <span class="n">ChainBuilder</span> <span class="o">=</span> <span class="n">ChainBuilder</span><span class="p">(</span>
            <span class="n">chat_prompt</span><span class="o">=</span><span class="n">chat_prompt_template</span><span class="p">,</span>
            <span class="n">llm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">,</span>
            <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">,</span>
            <span class="n">fallback_parser</span><span class="o">=</span><span class="n">fallback_parser</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">chain</span><span class="p">:</span> <span class="n">Runnable</span> <span class="o">=</span> <span class="n">chain_builder</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()</span>
        <span class="n">fallback_chain</span><span class="p">:</span> <span class="n">Runnable</span> <span class="o">=</span> <span class="n">chain_builder</span><span class="o">.</span><span class="n">get_fallback_chain</span><span class="p">()</span>

        <span class="c1"># Wrap the chain</span>
        <span class="n">chain_wrapper</span><span class="p">:</span> <span class="n">ChainWrapper</span> <span class="o">=</span> <span class="n">ChainWrapper</span><span class="p">(</span>
            <span class="n">chain</span><span class="o">=</span><span class="n">chain</span><span class="p">,</span>
            <span class="n">fallback_chain</span><span class="o">=</span><span class="n">fallback_chain</span><span class="p">,</span>
            <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">,</span>
            <span class="n">fallback_parser</span><span class="o">=</span><span class="n">fallback_parser</span><span class="p">,</span>
            <span class="n">preprocessor</span><span class="o">=</span><span class="n">preprocessor</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">,</span>
            <span class="n">postprocessor</span><span class="o">=</span><span class="n">postprocessor</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">postprocessor</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add the chain to the composer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_composer</span><span class="o">.</span><span class="n">add_chain</span><span class="p">(</span>
            <span class="n">chain_wrapper</span><span class="o">=</span><span class="n">chain_wrapper</span><span class="p">,</span>
            <span class="n">output_passthrough_key_name</span><span class="o">=</span><span class="n">output_passthrough_key_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Return the ChainManager instance to allow for method chaining</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="ChainManager._format_overwrite_warning">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._format_overwrite_warning">[docs]</a>
    <span class="k">def</span> <span class="nf">_format_overwrite_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrites</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Formats a warning message for overwritten values.</span>

<span class="sd">        Args:</span>
<span class="sd">            overwrites (Dict[str, Dict[str, Any]]):</span>
<span class="sd">            - A dictionary where the key is the name of the overwritten item, and the value is another dictionary with &#39;old&#39; and &#39;new&#39; keys representing the old and new values respectively.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A formatted string that lists each overwritten item with its old and new values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">    - </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;old&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">    + </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">overwrites</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager._check_first_time_overwrites">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._check_first_time_overwrites">[docs]</a>
    <span class="k">def</span> <span class="nf">_check_first_time_overwrites</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt_variables_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks and warns if any global chain variables are being overwritten for the first time.</span>

<span class="sd">        This method compares the keys in the provided `prompt_variables_dict` with the existing</span>
<span class="sd">        `chain_variables`. If any keys match, it indicates that an overwrite is occurring. A warning</span>
<span class="sd">        is issued the first time this happens, detailing the old and new values of the overwritten</span>
<span class="sd">        variables. Subsequent overwrites will not trigger warnings.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt_variables_dict (Dict[str, Any]):</span>
<span class="sd">            - A dictionary containing the new values for the chain variables that may overwrite existing ones.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_variables_update_overwrite_warning_counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">overwrites</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_variables</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                    <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">prompt_variables_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">prompt_variables_dict</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_variables</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">overwrites</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Overwriting existing global variables:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_overwrite_warning</span><span class="p">(</span><span class="n">overwrites</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Subsequent overwrites will not trigger warnings.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain_variables_update_overwrite_warning_counter</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="ChainManager._update_chain_variables">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager._update_chain_variables">[docs]</a>
    <span class="k">def</span> <span class="nf">_update_chain_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt_variables_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update global variables with new values, warning on first-time overwrites.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt_variables_dict (Dict[str, Any]):</span>
<span class="sd">            - A dictionary containing the new values for the global variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Update global variables with new values, warning on first-time overwrites.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_first_time_overwrites</span><span class="p">(</span><span class="n">prompt_variables_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">prompt_variables_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager.get_chain_sequence">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager.get_chain_sequence">[docs]</a>
    <span class="k">def</span> <span class="nf">get_chain_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ChainWrapper</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the chain sequence from the chain composer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Tuple[ChainWrapper, Optional[str]]]:</span>
<span class="sd">            - A list of tuples where each tuple contains a ChainWrapper object and the output key name if output_passthrough_key_name was provided to add_chain_layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_composer</span><span class="o">.</span><span class="n">chain_sequence</span></div>


<div class="viewcode-block" id="ChainManager.print_chain_sequence">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager.print_chain_sequence">[docs]</a>
    <span class="k">def</span> <span class="nf">print_chain_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints the chain sequence by formatting it.</span>

<span class="sd">        This method retrieves the chain sequence from the chain composer and</span>
<span class="sd">        formats it using the _format_chain_sequence method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chain_sequence</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ChainWrapper</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain_composer</span><span class="o">.</span><span class="n">chain_sequence</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_format_chain_sequence</span><span class="p">(</span><span class="n">chain_sequence</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager.get_chain_variables">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager.get_chain_variables">[docs]</a>
    <span class="k">def</span> <span class="nf">get_chain_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the chain variables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: A dictionary containing the chain variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_variables</span></div>


<div class="viewcode-block" id="ChainManager.print_chain_variables">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager.print_chain_variables">[docs]</a>
    <span class="k">def</span> <span class="nf">print_chain_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints the chain variables in a formatted manner.</span>

<span class="sd">        This method prints the chain variables stored in the `chain_variables`</span>
<span class="sd">        attribute of the class. The output is formatted with a header and</span>
<span class="sd">        footer consisting of dashes, and each key-value pair is printed on</span>
<span class="sd">        a new line.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chain Variables:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChainManager.set_words_to_ban">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager.set_words_to_ban">[docs]</a>
    <span class="k">def</span> <span class="nf">set_words_to_ban</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words_to_ban</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the list of words to ban and recreates the OpenAI LLM with new logit bias.</span>

<span class="sd">        Args:</span>
<span class="sd">            words_to_ban: List of words to ban from LLM output</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">words_to_ban</span> <span class="o">=</span> <span class="n">words_to_ban</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_words_to_ban</span><span class="p">(</span><span class="n">words_to_ban</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logit_bias_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logit_bias_dict</span><span class="p">(</span><span class="n">llm_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recreate_llm</span><span class="p">()</span></div>


<div class="viewcode-block" id="ChainManager.run">
<a class="viewcode-back" href="../../../chain_builder.html#academic_metrics.ChainBuilder.ChainBuilder.ChainManager.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">prompt_variables_dict</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">FirstCallRequired</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes the chain builder process.</span>

<span class="sd">        This method performs validation checks, updates chain variables if provided,</span>
<span class="sd">        and runs the chain composer with the current chain variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt_variables_dict (Union[FirstCallRequired, None], optional):</span>
<span class="sd">            - A dictionary containing prompt variables. If provided, it will be used to update the chain variables. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The result of running the chain composer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_validation_checks</span><span class="p">(</span>
            <span class="n">prompt_variables_dict</span><span class="o">=</span><span class="n">prompt_variables_dict</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">prompt_variables_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_chain_variables</span><span class="p">(</span><span class="n">prompt_variables_dict</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_composer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">data_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_variables</span><span class="p">,</span>
            <span class="n">data_dict_update_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_chain_variables</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
    

      <div class="clearer"></div>
    </div>
    <div class="button_nav_wrapper">
        <div class="button_nav">
            <div class="left">
                
            </div>

            <div class="right">
                
            </div>
        </div>
    </div>


    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Spencer Presley, Cole Barbes.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>

<p id="theme_credit">Styled using the <a href="https://github.com/piccolo-orm/piccolo_theme">Piccolo Theme</a></p>
  </body>
</html>